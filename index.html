<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å†¬å¤©ç»™äºˆæ¸©æš– Â· Winter Glow 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React / ReactDOM / Babelï¼ˆåœ¨ GitHub Pages ç›´æ¥ç”¨ï¼‰ -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Three.js ç”¨äº 3D ç²’å­çƒ -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

  <style>
    :root {
      --bg-night-1: #020617;
      --bg-night-2: #0b1120;
      --bg-snow-1: #0f172a;
      --bg-snow-2: #1e293b;
      --bg-dusk-1: #1e1b4b;
      --bg-dusk-2: #7c2d12;

      --txt-main: #e5e7eb;
      --txt-sub: #9ca3af;

      --accent-warm: #fb923c;
      --accent-warm-soft: #fed7aa;
      --accent-cold: #60a5fa;
      --accent-cold-soft: #bfdbfe;

      --glass-bg: rgba(15, 23, 42, 0.78);
      --glass-border: rgba(148, 163, 184, 0.7);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      background: radial-gradient(circle at top, #0b1120, #020617);
      color: var(--txt-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body { overflow-x: hidden; }

    #root { min-height: 100vh; }

    /* ä¸»å®¹å™¨ */
    .app {
      position: relative;
      min-height: 100vh;
      padding: 16px clamp(16px, 4vw, 32px) 32px;
      overflow: hidden;
      transition: background 0.6s ease, filter 0.4s ease;
    }

    /* æ˜Ÿç©ºèƒŒæ™¯ + çƒŸé›¾å±‚ï¼ˆè½»é‡ç‰ˆï¼‰ */
    .smoke-layer {
      position: fixed;
      inset: -20%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.45;
      transform: translate3d(0,0,0);
      will-change: transform;
    }

    .smoke-cloud {
      position: absolute;
      width: 60%;
      height: 60%;
      border-radius: 50%;
      filter: blur(22px);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.16), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(148, 163, 184, 0.22), transparent 65%);
      animation: smokeMove 28s ease-in-out infinite alternate;
    }

    .smoke-cloud.smoke-2 {
      left: 40%;
      top: 10%;
      animation-duration: 36s;
      animation-direction: alternate-reverse;
      opacity: 0.7;
    }

    @keyframes smokeMove {
      0%   { transform: translate3d(-8%, 6%, 0) scale(1); }
      50%  { transform: translate3d(6%, -3%, 0) scale(1.08); }
      100% { transform: translate3d(10%, 10%, 0) scale(1.02); }
    }

    /* Canvas é›ªèŠ± */
    .snow-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      opacity: 0.9;
      will-change: transform;
    }

    /* é¡¶æ  */
    .top-bar {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 18px;
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      border-radius: 12px;
      background: conic-gradient(from 220deg, #38bdf8, #fb923c, #a855f7, #38bdf8);
      box-shadow: 0 0 20px rgba(56,189,248,0.7);
      position: relative;
      overflow: hidden;
    }

    .logo-mark::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: inherit;
      background: radial-gradient(circle at 20% 0%, rgba(255,255,255,0.9), transparent 60%);
    }

    .logo-text-main { font-size: 16px; font-weight: 600; }
    .logo-text-sub { font-size: 11px; color: var(--txt-sub); }

    .top-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      font-size: 12px;
      color: var(--txt-sub);
    }

    .top-badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(12px);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot-live {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    /* ç»ç’ƒæŒ‰é’® */
    .glass-btn {
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--txt-main);
      padding: 7px 14px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.8),
        0 16px 36px rgba(15,23,42,0.95);
      backdrop-filter: blur(16px);
      transition: all 0.18s ease;
    }

    .glass-btn.small {
      padding: 6px 10px;
      font-size: 11px;
      box-shadow: none;
    }

    .glass-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.8),
        0 20px 48px rgba(15,23,42,1);
      background: linear-gradient(135deg, rgba(248,250,252,0.12), rgba(15,23,42,0.9));
    }

    .glass-btn:active {
      transform: translateY(0);
      box-shadow: 0 0 0 1px rgba(148,163,184,0.7);
    }

    /* ä¸ŠåŠéƒ¨åˆ†ï¼šæ–‡æ¡ˆ + å…‰çƒ */
    .hero {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 24px;
      align-items: center;
      margin-bottom: 16px;
    }

    @media (max-width: 860px) {
      .hero {
        grid-template-columns: minmax(0,1fr);
        align-items: flex-start;
      }
    }

    .hero-left {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: 520px;
    }

    .tag-line {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top left, rgba(148,163,184,0.45), rgba(15,23,42,0.9));
      font-size: 11px;
      color: var(--accent-cold-soft);
    }

    .tag-pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: var(--accent-warm-soft);
      font-size: 10px;
    }

    .title {
      font-size: clamp(28px, 5.2vw, 40px);
      line-height: 1.18;
    }

    .t-cold {
      background: linear-gradient(120deg, var(--accent-cold-soft), var(--accent-cold));
      -webkit-background-clip: text;
      color: transparent;
    }
    .t-warm {
      background: linear-gradient(120deg, var(--accent-warm-soft), var(--accent-warm));
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 13px;
      line-height: 1.9;
      color: var(--txt-sub);
    }

    .subtitle strong { color: #e5e7eb; font-weight: 500; }

    .hero-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }

    .mood-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--txt-sub);
    }

    .mood-row input[type="range"] {
      flex: 1;
      accent-color: #fb923c;
    }

    .hint-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--txt-sub);
    }

    .hint-badge {
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.8);
      padding: 2px 8px;
      font-size: 10px;
      color: var(--accent-cold-soft);
      margin-right: 6px;
    }

    /* å³ä¾§å…‰çƒ & 3D ç²’å­ */
    .hero-right {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .orb-wrapper {
      position: relative;
      width: min(360px, 80vw);
      aspect-ratio: 1/1;
      perspective: 800px;
      will-change: transform;
      transition: transform 0.25s ease-out;
    }

    .orb {
      position: absolute;
      inset: 12%;
      border-radius: 999px;
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.7), transparent 52%),
        radial-gradient(circle at 70% 80%, rgba(251,146,60,0.75), transparent 70%),
        radial-gradient(circle at 0% 80%, rgba(56,189,248,0.45), transparent 65%),
        #020617;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow:
        0 0 80px rgba(251,146,60,0.45),
        0 0 120px rgba(56,189,248,0.45);
      overflow: hidden;
      transform-style: preserve-3d;
    }

    .orb-breathe {
      animation: breathe 4.2s ease-in-out infinite;
    }

    @keyframes breathe {
      0%   { transform: translateZ(0) scale(1); }
      40%  { transform: translateZ(14px) scale(1.04); box-shadow: 0 0 120px rgba(251,146,60,0.7),0 0 180px rgba(56,189,248,0.6); }
      100% { transform: translateZ(0) scale(1); }
    }

    .orb-three-layer {
      position: absolute;
      inset: 9%;
      pointer-events: none;
    }

    .dot-ring {
      position: absolute;
      inset: 6%;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.6);
      box-shadow: 0 0 38px rgba(56,189,248,0.6);
    }

    .dot-cloud {
      position: absolute;
      inset: -10%;
      border-radius: 999px;
      background-image: radial-gradient(circle, rgba(148,163,184,0.8) 1px, transparent 1px);
      background-size: 30px 30px;
      mask-image: radial-gradient(circle, black 45%, transparent 90%);
      opacity: 0.75;
      animation: dotDrift 26s linear infinite;
    }

    @keyframes dotDrift {
      from { transform: translate3d(0,0,0) rotate(0deg); }
      to   { transform: translate3d(4px,-5px,0) rotate(360deg); }
    }

    .orb-card {
      position: absolute;
      right: 6%;
      bottom: 5%;
      min-width: 168px;
      padding: 9px 11px;
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      box-shadow: 0 18px 40px rgba(15,23,42,0.98);
      font-size: 11px;
      color: var(--txt-sub);
      backdrop-filter: blur(16px);
    }

    .orb-card-title {
      font-size: 12px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--txt-main);
    }

    .orb-card-badge {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.8);
      font-size: 10px;
      color: var(--accent-warm-soft);
    }

    .orb-card-temp {
      font-size: 11px;
      color: var(--accent-cold-soft);
      margin-bottom: 3px;
    }

    /* å¤©æ°” + æ—¥å†åŒºå— */
    .panel-grid {
      position: relative;
      z-index: 2;
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 16px;
      max-width: 1120px;
    }

    @media (max-width: 860px) {
      .panel-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .glass-card {
      border-radius: 16px;
      padding: 14px 16px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.8),
        0 18px 40px rgba(15,23,42,0.98);
      backdrop-filter: blur(18px);
    }

    .weather-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .weather-city {
      font-size: 15px;
      font-weight: 500;
    }

    .weather-desc {
      font-size: 12px;
      color: var(--txt-sub);
    }

    .temp-now {
      font-size: 30px;
      font-weight: 600;
    }

    .temp-feel {
      font-size: 12px;
      color: var(--txt-sub);
    }

    .weather-meta {
      font-size: 11px;
      color: var(--txt-sub);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
      margin-right: 4px;
    }

    .trend-title {
      font-size: 12px;
      color: var(--txt-sub);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trend-svg {
      width: 100%;
      height: 110px;
    }

    .trend-legend {
      margin-top: 4px;
      font-size: 10px;
      color: var(--txt-sub);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* æ—¥å† */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .cal-nav-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.7);
      color: var(--txt-main);
      font-size: 11px;
      cursor: pointer;
    }

    .cal-weekdays,
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      font-size: 11px;
      text-align: center;
    }

    .cal-weekdays {
      color: var(--txt-sub);
      margin-bottom: 4px;
    }

    .cal-day {
      padding: 5px 0;
      margin: 2px;
      border-radius: 8px;
      min-height: 28px;
      position: relative;
    }

    .cal-day.empty {
      opacity: 0.12;
    }

    .cal-day.today {
      border: 1px solid #fb923c;
      box-shadow: 0 0 10px rgba(251,146,60,0.7);
    }

    .cal-day.holiday-day {
      background: rgba(180,83,9,0.32);
      border: 1px solid rgba(251,146,60,0.8);
    }

    .cal-day .date { font-size: 12px; }
    .cal-day .holiday { font-size: 10px; color: #fed7aa; margin-top: 2px; }

    .cal-legend {
      margin-top: 6px;
      font-size: 11px;
      color: var(--txt-sub);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 4px;
      display: inline-block;
      margin-right: 4px;
    }

    .legend-holiday {
      background: rgba(180,83,9,0.65);
      border: 1px solid rgba(251,146,60,0.9);
    }

    .legend-today {
      border-radius: 999px;
      background: transparent;
      border: 1px solid #fb923c;
      box-shadow: 0 0 6px rgba(251,146,60,0.7);
    }

    /* ä¸‹æ–¹æ–‡å­—è¯´æ˜ */
    .story-scroll {
      position: relative;
      z-index: 2;
      max-width: 640px;
      margin-top: 20px;
      font-size: 12px;
      color: var(--txt-sub);
      line-height: 1.9;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 11px;
    }

    /* BGM æç¤º */
    .music-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--txt-sub);
      margin-top: 4px;
    }

    .music-dot-on {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #fb923c;
      box-shadow: 0 0 6px rgba(251,146,60,0.9);
    }

    @media (max-width: 600px) {
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-right {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<canvas id="snowCanvas" class="snow-canvas"></canvas>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;
const THREE = window.THREE;

// ====== å’Œé£å¤©æ°”é…ç½®ï¼ˆè®°å¾—æŠŠ key æ¢æˆä½ è‡ªå·±çš„ï¼Œå¦‚æœç°åœ¨è¿™ä¸ªä¸èƒ½ç”¨ï¼‰ ======
const QWEATHER_KEY = "9f09c671816448ba8a6e514466b7c31d"; // å¯æ¢æˆä½ åˆ›å»ºçš„ weather-key
const QWEATHER_DOMAIN = "https://mh7md9rpa5.re.qweatherapi.com"; // ä½ çš„ä¸“å±åŸŸå

// ä¸€äº›èŠ‚å‡æ—¥ç¤ºä¾‹ï¼ˆ2025ï¼‰
const CHINA_HOLIDAYS_2025 = {
  "2025-01-01": "å…ƒæ—¦",
  "2025-01-28": "æ˜¥èŠ‚",
  "2025-01-29": "æ˜¥èŠ‚",
  "2025-01-30": "æ˜¥èŠ‚",
  "2025-04-04": "æ¸…æ˜",
  "2025-05-01": "åŠ³åŠ¨",
  "2025-06-01": "å„¿ç«¥",
  "2025-10-01": "å›½åº†",
  "2025-10-02": "å›½åº†",
  "2025-10-03": "å›½åº†"
};

// å°å·¥å…·
const isMobile = () =>
  typeof window !== "undefined" &&
  (window.innerWidth <= 768 ||
   (window.matchMedia && window.matchMedia("(pointer: coarse)").matches));

function toYMD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

function bgTempMode(feel) {
  if (feel == null || isNaN(feel)) return "neutral";
  if (feel <= 5) return "cold";
  if (feel >= 16) return "warm";
  return "neutral";
}

/** å°è¯•æŠŠ response å½“ JSON è§£æï¼Œè§£æå¤±è´¥åˆ™è¿”å› null */
async function safeJson(resp) {
  try {
    const text = await resp.text();
    if (!text) return null;
    return JSON.parse(text);
  } catch {
    return null;
  }
}

// ====== é›ªèŠ± Canvasï¼ˆå…¨å±€ï¼‰ ======
function initSnowCanvas() {
  const canvas = document.getElementById("snowCanvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  let width, height;
  function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener("resize", resize);

  const count = isMobile() ? 55 : 120;
  const flakes = Array.from({ length: count }).map(() => ({
    x: Math.random() * width,
    y: Math.random() * height,
    r: Math.random() * 1.8 + 0.6,
    vy: Math.random() * 0.7 + 0.3,
    vx: (Math.random() - 0.5) * 0.4
  }));

  let running = true;
  function render() {
    if (!running) return;
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = "rgba(248,250,252,0.9)";
    flakes.forEach(f => {
      f.y += f.vy;
      f.x += f.vx;
      if (f.y > height + 5) {
        f.y = -10;
        f.x = Math.random() * width;
      }
      if (f.x > width) f.x = 0;
      if (f.x < 0) f.x = width;
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(render);
  }
  render();

  return () => {
    running = false;
    window.removeEventListener("resize", resize);
  };
}

// ====== 3D ç²’å­å…‰çƒï¼ˆThree.jsï¼Œæ€§èƒ½å‹å¥½ç‰ˆï¼‰ ======
function useOrbThree(ref, sceneMode, tempMode) {
  useEffect(() => {
    if (!ref.current || !THREE) return;

    const container = ref.current;
    const width = container.clientWidth || 200;
    const height = container.clientHeight || width;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, width / height, 0.1, 100);
    camera.position.z = 3;

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    container.innerHTML = "";
    container.appendChild(renderer.domElement);

    const num = isMobile() ? 260 : 620;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(num * 3);

    for (let i = 0; i < num; i++) {
      const r = 1.15 + Math.random() * 0.08;
      const theta = Math.random() * 2 * Math.PI;
      const phi = Math.acos(2 * Math.random() - 1);
      const x = r * Math.sin(phi) * Math.cos(theta);
      const y = r * Math.sin(phi) * Math.sin(theta);
      const z = r * Math.cos(phi);
      positions[3 * i] = x;
      positions[3 * i + 1] = y;
      positions[3 * i + 2] = z;
    }
    geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));

    const material = new THREE.PointsMaterial({
      color: 0xffe7a3,
      size: 0.028,
      transparent: true,
      opacity: 0.9,
      sizeAttenuation: true
    });

    const points = new THREE.Points(geometry, material);
    scene.add(points);

    // æ ¹æ®åœºæ™¯å’Œæ¸©åº¦è°ƒé¢œè‰²
    function updateColor() {
      if (sceneMode === "snow") {
        material.color.set(0xc4e4ff);
      } else if (sceneMode === "dusk") {
        material.color.set(0xffbf8b);
      } else {
        // night
        if (tempMode === "cold") material.color.set(0x86c5ff);
        else if (tempMode === "warm") material.color.set(0xffd28a);
        else material.color.set(0xffe7a3);
      }
    }
    updateColor();

    let frameId;
    const speedBase = isMobile() ? 0.0022 : 0.0032;

    function animate() {
      frameId = requestAnimationFrame(animate);
      points.rotation.y += speedBase;
      points.rotation.x += speedBase * 0.4;
      renderer.render(scene, camera);
    }
    animate();

    function handleResize() {
      const w = container.clientWidth || 200;
      const h = container.clientHeight || w;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", handleResize);

    return () => {
      cancelAnimationFrame(frameId);
      window.removeEventListener("resize", handleResize);
      geometry.dispose();
      material.dispose();
      renderer.dispose();
      container.innerHTML = "";
    };
  }, [ref, sceneMode, tempMode]);
}

// ====== å¤©æ°” + 3 å¤©è¶‹åŠ¿ hookï¼ˆåªç”¨å…è´¹æ¥å£ï¼‰ ======
function useWeather(onFeelsLike) {
  const [location, setLocation] = useState(null);
  const [now, setNow] = useState(null);
  const [daily, setDaily] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    async function fetchWeather(lat, lon) {
      try {
        setLoading(true);
        setError(null);

        const locParam = `${lon.toFixed(2)},${lat.toFixed(2)}`;

        // 1. åŸå¸‚åæŸ¥
        const cityResp = await fetch(
          `${QWEATHER_DOMAIN}/v2/city/lookup?location=${locParam}&key=${QWEATHER_KEY}`
        );
        const cityJson = await safeJson(cityResp);
        if (!cityJson || cityJson.code !== "200" || !cityJson.location?.length) {
          throw new Error("åŸå¸‚æŸ¥è¯¢å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ key æˆ–åŸŸåè®¾ç½®é—®é¢˜ï¼‰");
        }
        const city = cityJson.location[0];
        setLocation({ name: city.name, adm1: city.adm1, id: city.id });

        // 2. å®æ—¶å¤©æ°”
        const nowResp = await fetch(
          `${QWEATHER_DOMAIN}/v7/weather/now?location=${city.id}&key=${QWEATHER_KEY}`
        );
        const nowJson = await safeJson(nowResp);
        if (!nowJson || nowJson.code !== "200" || !nowJson.now) {
          throw new Error("å®æ—¶å¤©æ°”æŸ¥è¯¢å¤±è´¥");
        }
        const feel = Number(nowJson.now.feelsLike);
        setNow({
          temp: Number(nowJson.now.temp),
          feelsLike: feel,
          text: nowJson.now.text,
          obsTime: nowJson.updateTime
        });
        if (typeof onFeelsLike === "function" && !Number.isNaN(feel)) {
          onFeelsLike(feel);
        }

        // 3. ä¸‰å¤©å¤©æ°”ï¼ˆè¶‹åŠ¿ï¼‰
        const dailyResp = await fetch(
          `${QWEATHER_DOMAIN}/v7/weather/3d?location=${city.id}&key=${QWEATHER_KEY}`
        );
        const dailyJson = await safeJson(dailyResp);
        if (dailyJson && dailyJson.code === "200" && Array.isArray(dailyJson.daily)) {
          const arr = dailyJson.daily.slice(0, 3).map(d => ({
            date: d.fxDate,
            text: d.textDay,
            tempMin: Number(d.tempMin),
            tempMax: Number(d.tempMax)
          }));
          setDaily(arr);
        } else {
          setDaily([]);
        }
      } catch (err) {
        console.error(err);
        setError(err.message || "è¯·æ±‚å¤±è´¥");
      } finally {
        setLoading(false);
      }
    }

    function byGeoOrFallback() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
          () => fetchWeather(39.92, 116.41), // é»˜è®¤åŒ—äº¬
          { enableHighAccuracy: false, timeout: 5000 }
        );
      } else {
        fetchWeather(39.92, 116.41);
      }
    }

    byGeoOrFallback();
  }, [onFeelsLike]);

  return { location, now, daily, loading, error };
}

// ====== æ—¥å†ç»„ä»¶ ======
function CalendarPanel() {
  const [currentMonth, setCurrentMonth] = useState(() => {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1);
  });

  const today = new Date();
  const todayYMD = toYMD(today);
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  const firstDay = new Date(year, month, 1);
  const firstWeekday = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const cells = [];
  for (let i = 0; i < firstWeekday; i++) {
    cells.push({ empty: true, key: `e-${i}` });
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const ymd = toYMD(date);
    const holidayName = CHINA_HOLIDAYS_2025[ymd];
    const isToday = ymd === todayYMD;
    cells.push({
      empty: false,
      day: d,
      ymd,
      holidayName,
      isToday,
      key: ymd
    });
  }

  const prevMonth = () => {
    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
  };
  const nextMonth = () => {
    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
  };

  const monthLabel = `${year} å¹´ ${(month + 1).toString().padStart(2,"0")} æœˆ`;

  return (
    <div className="glass-card">
      <div className="calendar-header">
        <span>{monthLabel}</span>
        <div>
          <button className="cal-nav-btn" onClick={prevMonth}>â—€</button>
          <button className="cal-nav-btn" onClick={nextMonth} style={{ marginLeft: 6 }}>â–¶</button>
        </div>
      </div>
      <div className="cal-weekdays">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div>
        <div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div className="cal-grid">
        {cells.map(cell => {
          if (cell.empty) return <div key={cell.key} className="cal-day empty" />;
          const cls = [
            "cal-day",
            cell.isToday ? "today" : "",
            cell.holidayName ? "holiday-day" : ""
          ].filter(Boolean).join(" ");
          return (
            <div key={cell.key} className={cls}>
              <div className="date">{cell.day}</div>
              {cell.holidayName && (
                <div className="holiday">{cell.holidayName}</div>
              )}
            </div>
          );
        })}
      </div>
      <div className="cal-legend">
        <span>
          <span className="legend-dot legend-holiday"></span>èŠ‚å‡æ—¥ï¼ˆç¤ºä¾‹ï¼š2025 éƒ¨åˆ†ï¼‰
        </span>
        <span>
          <span className="legend-dot legend-today"></span>ä»Šæ—¥
        </span>
      </div>
    </div>
  );
}

// ====== å¤©æ°”å¡ç‰‡ï¼ˆä½¿ç”¨å…è´¹æ¥å£ç»“æœï¼‰ ======
function WeatherPanel({ onFeelsLikeChange }) {
  const { location, now, daily, loading, error } = useWeather(onFeelsLikeChange);

  const minAll = daily.length
    ? Math.min(...daily.map(d => d.tempMin))
    : null;
  const maxAll = daily.length
    ? Math.max(...daily.map(d => d.tempMax))
    : null;
  const range = maxAll != null ? Math.max(maxAll - minAll, 1) : 1;

  // ç”Ÿæˆ 3 å¤©å°è¶‹åŠ¿æ¡å½¢å›¾
  const bars = daily.map((d, idx) => {
    const h = ((d.tempMax - minAll) / range) * 70 + 10; // ç™¾åˆ†æ¯”é«˜åº¦
    return { h, idx, label: d.date.slice(5), text: d.text };
  });

  return (
    <div className="glass-card">
      <div className="weather-top">
        <div>
          <div className="weather-city">
            {location ? `${location.name} Â· ${location.adm1}` : "å®šä½ä¸­â€¦"}
          </div>
          <div className="weather-desc">
            {now
              ? `${now.text} Â· å®æ—¶ä½“æ„Ÿæ¸©åº¦`
              : "æ­£åœ¨è¯·æ±‚å®æ—¶å¤©æ°”æ•°æ®â€¦"}
          </div>
        </div>
        <div>
          <div className="temp-now">
            {now ? `${now.temp.toFixed(0)}Â°` : "--"}
          </div>
          <div className="temp-feel">
            {now ? `ä½“æ„Ÿ ${now.feelsLike.toFixed(0)}Â°C` : "ä½“æ„Ÿæ¸©åº¦åŠ è½½ä¸­"}
          </div>
        </div>
      </div>

      <div className="weather-meta">
        <span><span className="status-dot" />æ•°æ®æºï¼šå’Œé£å¤©æ°” QWeather</span>
        {now?.obsTime && (
          <span>æ›´æ–°ï¼š{now.obsTime.replace("T"," ").slice(0,16)}</span>
        )}
        {minAll != null && maxAll != null && (
          <span>æœªæ¥ 3 å¤©åŒºé—´ï¼š{minAll.toFixed(0)}Â° ~ {maxAll.toFixed(0)}Â°C</span>
        )}
      </div>

      {loading && (
        <div style={{ fontSize: 12, color: "var(--txt-sub)" }}>
          æ­£åœ¨è·å–å®šä½ä¸å¤©æ°”æ•°æ®â€¦
        </div>
      )}

      {error && (
        <div style={{ fontSize: 12, color: "#fca5a5", marginBottom: 6 }}>
          è·å–å¤©æ°”å¤±è´¥ï¼š{error}ï¼ˆå¯ç¨ååˆ·æ–°ï¼Œæˆ–æ£€æŸ¥ key / åŸŸåé…ç½®ï¼‰
        </div>
      )}

      {!loading && !error && daily.length > 0 && (
        <>
          <div className="trend-title">
            <span>æœªæ¥ 3 å¤©æ¸©åº¦è¶‹åŠ¿ï¼ˆå…è´¹æ¥å£ç‰ˆï¼‰</span>
            <span style={{ fontSize: 11 }}>é•¿æ¡è¶Šé«˜è¡¨ç¤ºæœ€é«˜æ¸©è¶Šé«˜</span>
          </div>
          <svg viewBox="0 0 100 80" className="trend-svg" preserveAspectRatio="none">
            <line x1="0" y1="75" x2="100" y2="75"
              stroke="rgba(148,163,184,0.4)" strokeWidth="0.4" />
            {bars.map((b, idx) => {
              const barWidth = 16;
              const gap = 22;
              const x = 15 + idx * gap;
              const y = 75 - b.h * 0.7;
              return (
                <g key={idx}>
                  <rect
                    x={x}
                    y={y}
                    width={barWidth}
                    height={75 - y}
                    rx="3"
                    fill={idx === 0 ? "#60a5fa" : idx === 1 ? "#38bdf8" : "#fb923c"}
                    opacity="0.9"
                  />
                  <text
                    x={x + barWidth / 2}
                    y={78}
                    fontSize="7"
                    textAnchor="middle"
                    fill="rgba(148,163,184,0.9)"
                  >
                    {daily[idx].date.slice(5)}
                  </text>
                </g>
              );
            })}
          </svg>
          <div className="trend-legend">
            {daily.map((d, idx) => (
              <span key={idx}>
                {d.date.slice(5)} Â· {d.text} Â· {d.tempMin.toFixed(0)}Â°~{d.tempMax.toFixed(0)}Â°
              </span>
            ))}
          </div>
        </>
      )}
    </div>
  );
}

// ====== ä¸»åº”ç”¨ç»„ä»¶ ======
function App() {
  const [scene, setScene] = useState("night"); // night / snow / dusk
  const [mood, setMood] = useState(50);
  const [feelsLike, setFeelsLike] = useState(null);
  const [musicOn, setMusicOn] = useState(false);

  const orbThreeRef = useRef(null);
  const orbRef = useRef(null);
  const smokeRef = useRef(null);
  const orbWrapRef = useRef(null);
  const audioRef = useRef(null);

  const mobile = isMobile();

  // åˆå§‹åŒ–é›ªèŠ±
  useEffect(() => {
    const cleanup = initSnowCanvas();
    return cleanup;
  }, []);

  // Three.js ç²’å­çƒ
  const tempMode = bgTempMode(feelsLike);
  useOrbThree(orbThreeRef, scene, tempMode);

  // è§†å·®æ»šåŠ¨ï¼ˆè½»é‡ï¼‰
  useEffect(() => {
    function onScroll() {
      const y = window.scrollY || 0;
      const offset = y * 0.04;
      if (smokeRef.current) {
        smokeRef.current.style.transform = `translate3d(0, ${-offset}px, 0)`;
      }
      if (orbWrapRef.current && !mobile) {
        orbWrapRef.current.style.transform = `translate3d(0, ${offset * 0.8}px, 0)`;
      }
    }
    window.addEventListener("scroll", onScroll);
    onScroll();
    return () => window.removeEventListener("scroll", onScroll);
  }, [mobile]);

  // å…‰çƒè·Ÿéšé¼ æ ‡è½»å¾®å€¾æ–œï¼ˆä»… PCï¼‰
  useEffect(() => {
    if (mobile) return;
    function onMove(e) {
      if (!orbRef.current) return;
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      const dx = (e.clientX - cx) / 40;
      const dy = (e.clientY - cy) / 40;
      orbRef.current.style.transform = `rotateX(${-dy}deg) rotateY(${dx}deg)`;
    }
    window.addEventListener("mousemove", onMove);
    return () => window.removeEventListener("mousemove", onMove);
  }, [mobile]);

  // BGM
  useEffect(() => {
    if (!audioRef.current) {
      // æµªæ¼«é’¢ç´ BGMï¼ˆå¯æ¢æˆä½ å–œæ¬¢çš„ï¼‰
      audioRef.current = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a034e25ce.mp3?filename=romantic-piano-110253.mp3"
      );
      audioRef.current.loop = true;
      audioRef.current.volume = 0.6;
    }
    if (musicOn) {
      audioRef.current.play().catch(() => {});
    } else {
      audioRef.current.pause();
    }
  }, [musicOn]);

  const sceneLabel = {
    night: "é»‘å¤œ Â· Night",
    snow: "é›ªå¤œ Â· Snowy Night",
    dusk: "é»„æ˜ Â· Dusk Glow"
  }[scene];

  const moodLabel =
    mood < 30 ? "åå†·é™" :
    mood < 70 ? "å¹³ç¨³" : "åæ¸©æš–";

  const moodFilter = `hue-rotate(${(mood - 50) * 0.7}deg) saturate(${0.9 + mood/130}) brightness(${0.95 + mood/350})`;

  // æ ¹æ®åœºæ™¯ + æ¸©åº¦è®¾ç½®èƒŒæ™¯
  let bg;
  if (scene === "night") {
    if (tempMode === "cold") {
      bg = `radial-gradient(circle at top, #0f172a, #020617)`;
    } else if (tempMode === "warm") {
      bg = `radial-gradient(circle at top, #7c2d12, #020617)`;
    } else {
      bg = `radial-gradient(circle at top, var(--bg-night-2), var(--bg-night-1))`;
    }
  } else if (scene === "snow") {
    bg = `radial-gradient(circle at top, var(--bg-snow-2), var(--bg-snow-1))`;
  } else {
    bg = `radial-gradient(circle at top, var(--bg-dusk-2), var(--bg-dusk-1))`;
  }

  return (
    <>
      {/* çƒŸé›¾å±‚ */}
      <div className="smoke-layer" ref={smokeRef}>
        <div className="smoke-cloud" />
        <div className="smoke-cloud smoke-2" />
      </div>

      <div className="app" style={{ background: bg, filter: moodFilter }}>
        {/* é¡¶æ  */}
        <div className="top-bar">
          <div className="logo-block">
            <div className="logo-mark" />
            <div>
              <div className="logo-text-main">Winter Glow 2.0</div>
              <div className="logo-text-sub">å†¬å¤©ç»™äºˆæ¸©æš– Â· å¤©æ°” & æ—¥å† & ç²’å­å…‰çƒ</div>
            </div>
          </div>

          <div className="top-right">
            <div className="top-badge">
              <span className="dot-live" />
              <span>{sceneLabel}</span>
            </div>
            <button
              className="glass-btn small"
              onClick={() => setMusicOn(v => !v)}
            >
              {musicOn ? "ğŸ”Š å…³é—­æµªæ¼« BGM" : "ğŸ§ æ‰“å¼€æµªæ¼« BGM"}
            </button>
          </div>
        </div>

        {/* ä¸ŠåŠï¼šæ–‡æ¡ˆ + å…‰çƒ */}
        <div className="hero">
          <div className="hero-left">
            <div className="tag-line">
              å†¬å¤œ Â· å¤©æ°” Â· æƒ…ç»ªå®éªŒç©ºé—´
              <span className="tag-pill">react Â· three.js Â· qweather</span>
            </div>
            <div className="title">
              è®©<span className="t-cold">çœŸå®çš„å¤©æ°”</span>ï¼Œ<br />
              ä¹Ÿèƒ½ä¸º<span className="t-warm">è¿™ä¸ªå†¬å¤©çš„æƒ…ç»ª</span>æä¾›ä¸€ç‚¹å‚è€ƒã€‚
            </div>
            <div className="subtitle">
              å·¦ä¾§æ˜¯ä½ æ‰€åœ¨çš„å®æ—¶å¤©æ°” + æœªæ¥ <strong>3 å¤©</strong> æ¸©åº¦å˜åŒ–ï¼Œ
              èƒŒæ™¯ä¼šéšç€ä½“æ„Ÿæ¸©åº¦è‡ªåŠ¨åœ¨å†·è‰² / ä¸­æ€§è‰² / æš–è‰²ä¹‹é—´è½»è½»åç§»ã€‚<br />
              å³ä¾§æ˜¯ä¸€ä¸ªè£…ç€æ— æ•°ç²’å­çš„å…‰çƒï¼Œä»£è¡¨è¿™ä¸ªå­£èŠ‚é‡Œ
              <strong>æ‰€æœ‰è¢«å¥½å¥½æ¥ä½çš„ç¬é—´</strong>ï¼šæœ‰äººé—®ä½ åˆ°å®¶äº†æ²¡ã€æœ‰äººæé†’ä½ å¤šç©¿è¡£æœï¼Œ
              æˆ–è€…ä½ è‡ªå·±æ›¿è‡ªå·±æ³¡äº†ä¸€æ¯çƒ­é¥®ã€‚
            </div>

            <div className="hero-buttons">
              <button className="glass-btn small" onClick={() => setScene("night")}>ğŸŒŒ é»‘å¤œåœºæ™¯</button>
              <button className="glass-btn small" onClick={() => setScene("snow")}>â„ï¸ é›ªå¤œåœºæ™¯</button>
              <button className="glass-btn small" onClick={() => setScene("dusk")}>ğŸŒ‡ é»„æ˜åœºæ™¯</button>
            </div>

            <div className="mood-row">
              <span>å¿ƒæƒ…ï¼š</span>
              <input
                type="range"
                min="0"
                max="100"
                value={mood}
                onChange={e => setMood(Number(e.target.value))}
              />
              <span>{moodLabel}</span>
            </div>

            <div className="hint-text">
              <span className="hint-badge">å°æç¤º</span>
              å»ºè®®æ…¢æ…¢æ»‘åŠ¨å¿ƒæƒ…æ»‘æ†ï¼Œçœ‹çœ‹å…‰çƒå’ŒèƒŒæ™¯åœ¨ä½ çœ¼å‰ä¸€ç‚¹ç‚¹å˜è‰²ã€‚
              è¿™ä¸æ˜¯åœ¨æ§åˆ¶ä¸–ç•Œçš„å¤©æ°”ï¼Œåªæ˜¯åœ¨å¸®ä½ ä¸ºä»Šå¤©æ‰¾ä¸€ä¸ªåˆé€‚çš„è‰²æ¸©ã€‚
            </div>
            <div className="music-status">
              <span className={musicOn ? "music-dot-on" : ""}></span>
              <span>{musicOn ? "BGM å·²å¼€å¯ï¼šå†¬å¤œæµªæ¼«é’¢ç´å¾ªç¯ä¸­" : "ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®ï¼Œå¯ä»¥ä¸ºè¿™ä¸ªé¡µé¢åŠ ä¸€ç‚¹èƒŒæ™¯éŸ³ä¹"}</span>
            </div>
          </div>

          <div className="hero-right">
            <div className="orb-wrapper" ref={orbWrapRef}>
              <div className={`orb ${!mobile ? "orb-breathe" : ""}`} ref={orbRef}>
                <div className="orb-three-layer" ref={orbThreeRef} />
              </div>
              <div className="dot-cloud" />
              <div className="dot-ring" />
              <div className="orb-card">
                <div className="orb-card-title">
                  å†¬å¤œæ¸©åº¦æ¡£æ¡ˆ
                  <span className="orb-card-badge">
                    {tempMode === "cold" ? "å†·åŒº" : tempMode === "warm" ? "æš–åŒº" : "ä¸­æ€§"}
                  </span>
                </div>
                <div className="orb-card-temp">
                  ä½“æ„Ÿæ¸©åº¦ï¼š
                  {feelsLike != null ? `${feelsLike.toFixed(0)}Â°C` : "ç­‰å¾…å¤©æ°”æ¥å£è¿”å›ä¸­â€¦"}
                </div>
                <div>
                  æ¥æºï¼šçƒ­é¥® / æ£‰è¢« / å±å¹•å‰è®¤çœŸçœ‹å®Œè¿™æ®µæ–‡å­—çš„ä½ ã€‚è¿™ä¸ªå…‰çƒåªè´Ÿè´£æé†’ï¼Œ
                  å†¬å¤©ä¹Ÿå¯ä»¥æ…¢æ…¢è¢«ç‚¹äº®ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* å¤©æ°” + æ—¥å† */}
        <div className="panel-grid">
          <WeatherPanel onFeelsLikeChange={setFeelsLike} />
          <CalendarPanel />
        </div>

        {/* ä¸‹æ–¹è¯´æ˜æ–‡å­— */}
        <div className="story-scroll">
          æœ‰æ—¶å€™æˆ‘ä»¬ä¼šè§‰å¾—ï¼Œå†¬å¤©æ˜¯æ¼«é•¿ã€å†·ã€éš¾ç†¬çš„ã€‚å…¶å®å¾ˆå¤šè®°å¿†ï¼Œ
          éƒ½å‘ç”Ÿåœ¨è¿™æ ·çš„å­£èŠ‚é‡Œï¼šç¬¬ä¸€æ¬¡ç†¬å¤œèµ¶é¡¹ç›®ã€ç¬¬ä¸€æ¬¡å’Œæœ‹å‹å‡Œæ™¨å»ä¾¿åˆ©åº—ä¹°çƒ­é¥®ã€
          ç¬¬ä¸€æ¬¡æ„è¯†åˆ°â€œåŸæ¥æœ‰äººä¼šåœ¨æˆ‘å›å¯å®¤çš„æ—¶å€™ç­‰ä¸€æ¡æ¶ˆæ¯â€ã€‚<br /><br />
          ä½ å¯ä»¥æŠŠè¿™ä¸ªé¡µé¢å½“æˆä¸€ä¸ªå°å°çš„ã€ä¸å¤ªæ‰“æ‰°åˆ«äººçš„å†¬å¤œå®éªŒå®¤ï¼š
          æŒ‘ä¸€ä¸ªåœºæ™¯ã€è°ƒä¸€ä¸‹å¿ƒæƒ…æ»‘æ†ã€å…³æ‰æˆ–æ‰“å¼€éŸ³ä¹ï¼Œå†çœ‹çœ‹ä¸‹é¢è¿™å‡ å¤©çš„å¤©æ°”å’Œæ—¥å†ï¼Œ
          æƒ³ä¸€æƒ³æ¥ä¸‹æ¥å‡ å¤©è¦åšçš„äº‹ã€‚<br />
          å½“ä½ æŸå¤©åˆ·åˆ°è¿™é‡Œï¼Œå“ªæ€•åªæ˜¯åœç•™å‡ ç§’ï¼Œä¹Ÿè®¸å°±è¶³å¤Ÿäº†ã€‚
          <div className="footer-note">
            æç¤ºï¼šèŠ‚å‡æ—¥ç¤ºä¾‹æŒ‰ 2025 éƒ¨åˆ†æ—¥æœŸæ‰‹åŠ¨é…ç½®ï¼Œåªç”¨äºæ¼”ç¤ºï¼›ä½ å¯ä»¥åœ¨ä»£ç ä¸­ç»§ç»­è¡¥å…¨éƒ¨åˆ†å¹´ä»½çš„èŠ‚å‡æ—¥è¡¨ã€‚
          </div>
        </div>
      </div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
